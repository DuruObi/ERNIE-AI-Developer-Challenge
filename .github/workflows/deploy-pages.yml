name: Deploy Pages
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate site
        env:
          ERNIE_API_URL: ${{ secrets.ERNIE_API_URL }}
          ERNIE_API_KEY: ${{ secrets.ERNIE_API_KEY }}
        run: |
          python src/pdf_to_images.py data/samples/yourfile.pdf
          python src/ocr_infer.py --images "data/uploads/*.png" --out data/uploads/ocr_output.json
          python src/ocr_to_md.py --in data/uploads/ocr_output.json --out demo/raw.md
          python src/ernie_client.py
          # wrap if necessary
          python - <<'PY'
from pathlib import Path
p = Path("demo/index.html")
if p.exists() and "<html" not in p.read_text(encoding='utf-8')[:200]:
    body = p.read_text(encoding='utf-8')
    html = f"<!doctype html><html lang='en'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/><title>Doc2Web</title><link rel='stylesheet' href='styles.css'/></head><body>{body}<footer><small>Generated by Doc2Web</small></footer></body></html>"
    p.write_text(html, encoding='utf-8')
PY

      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./demo
